generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      Int                @id @default(autoincrement())
  email                   String             @unique
  role                    Role               @default(USER)
  phone                   String?            @unique
  password                String?
  refreshToken            String?
  fitbitAccessToken       String?
  fitbitRefreshToken      String?
  fitbitAccessTokenExpiry DateTime?
  stravaAccessToken       String?
  stravaRefreshToken      String?
  stravaAccessTokenExpiry DateTime?
  isAgreeTerms            Boolean            @default(false)
  otp                     String?
  otpExpiry               DateTime?
  isDeleted               Boolean            @default(false)
  changePasswordAt        DateTime?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @default(now()) @updatedAt
  chats                   Chat[]             @relation("ChatSender")
  conversations           Conversation[]
  deviceIntegration       DeviceIntegration?
  labReports              LabReport[]
  meals                   Meal[]
  notification            Notification?
  nudges                  Nudge[]
  profile                 Profile?
  tips                    Tip[]
  vitalSigns              VitalSigns?

  // Index only on createdAt for time-based queries
  @@index([createdAt])
}

model Profile {
  id                   Int         @id @default(autoincrement())
  userId               Int         @unique
  photo                String?
  fullName             String?
  isEnableNotification Boolean     @default(false)
  language             Language    @default(EN)
  dateOfBirth          DateTime?
  gender               Gender?
  height               Float?      // Changed to Float for numeric operations
  weight               Float?      // Changed to Float for numeric operations
  healthGoal           HealthGoal?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @default(now()) @updatedAt
  user                 User        @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Notification {
  id                 Int       @id @default(autoincrement())
  userId             Int       @unique
  activityReminders  Boolean   @default(false)
  mealTracking       Boolean   @default(false)
  sleepInsights      Boolean   @default(false)
  progressUpdates    Boolean   @default(false)
  waterIntake        Boolean   @default(false)
  motivationalNudges Boolean   @default(false)
  wellnessTips       Boolean   @default(false)
  personalizedTips   Boolean   @default(false)
  systemAlerts       Boolean   @default(false)
  doNotDisturb       Boolean   @default(false)
  doNotDisturbStart  DateTime?
  doNotDisturbEnd    DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @default(now()) @updatedAt
  user               User      @relation(fields: [userId], references: [id])

  @@index([userId])
}

model DeviceIntegration {
  id                      Int       @id @default(autoincrement())
  userId                  Int       @unique
  appleHealth_isConnected Boolean   @default(false)
  appleHealth_lastSync    DateTime?
  googleFit_isConnected   Boolean   @default(false)
  googleFit_lastSync      DateTime?
  fitbit_isConnected      Boolean   @default(false)
  fitbit_lastSync         DateTime?
  strava_isConnected      Boolean   @default(false)
  strava_lastSync         DateTime?
  auto_sync               DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @default(now()) @updatedAt
  user                    User      @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Nudge {
  id             Int           @id @default(autoincrement())
  userId         Int
  title          String
  category       NudgeCategory
  targetAmount   Float?        // e.g., 8 for sleep hours, 8800 for steps, 2500 for hydration ml
  consumedAmount Float?
  unit           String?       // e.g., "hours", "steps", "ml", "kg"
  date           DateTime      @default(now())
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now()) @updatedAt
  isDeleted      Boolean       @default(false)
  user           User          @relation(fields: [userId], references: [id])
  tips           Tip[]

  // Index on userId and category for frequent filtering
  @@index([userId, category])
  @@index([date])
}

model VitalSigns {
  id         Int                @id @default(autoincrement())
  userId     Int                @unique
  dataFrom   String
  additional AdditionalMetrics?
  heartRate  HeartRate?
  sleep      Sleep?
  step       Step?
  user       User               @relation(fields: [userId], references: [id])

  @@index([userId])
}

model HeartRate {
  id        Int      @id @default(autoincrement())
  vitalId   Int      @unique
  heartRate Int?
  updatedAt DateTime @default(now()) @updatedAt
  resting   Int?     // Changed to Int for numeric operations
  average   Int?     // Changed to Int for numeric operations
  peak      Int?     // Changed to Int for numeric operations
  message   Json?    // Changed to Json for flexible storage
  vital     VitalSigns @relation(fields: [vitalId], references: [id])

  @@index([vitalId])
}

model Step {
  id         Int        @id @default(autoincrement())
  vitalId    Int        @unique
  stepsCount Int
  distance   Float      // Changed to Float for precision
  calories   Float      // Changed to Float for precision
  activeMin  Int
  message    Json?      // Changed to Json for flexible storage
  vital      VitalSigns @relation(fields: [vitalId], references: [id])

  @@index([vitalId])
}

model Sleep {
  id           Int        @id @default(autoincrement())
  vitalId      Int        @unique
  sleepStartAt DateTime
  sleepEndAt   DateTime
  deep         Float?     // Changed to Float for numeric operations
  rem          Float?     // Changed to Float for numeric operations
  light        Float?     // Changed to Float for numeric operations
  message      Json?      // Changed to Json for flexible storage
  vital        VitalSigns @relation(fields: [vitalId], references: [id])

  @@index([vitalId])
}

model AdditionalMetrics {
  id                   Int        @id @default(autoincrement())
  vitalId              Int        @unique
  heartRateVariability Int
  bodyTemp             Float      // Changed to Float for precision
  respiratoryRate      Int
  vital                VitalSigns @relation(fields: [vitalId], references: [id])

  @@index([vitalId])
}

model Meal {
  id          Int      @id @default(autoincrement())
  userId      Int
  photo       String?
  name        String
  mealType    MealType
  isCompleted Boolean  @default(false)
  note        String?
  calories    Float?   // Changed to Float for numeric operations
  protein     Float?   // Changed to Float for numeric operations
  carbs       Float?   // Changed to Float for numeric operations
  fats        Float?   // Changed to Float for numeric operations
  time        DateTime? // Changed to DateTime for proper time handling
  isDeleted   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId, mealType])
  @@index([createdAt])
}

model LabReport {
  id     Int     @id @default(autoincrement())
  userId Int
  photo  String?
  user   User    @relation(fields: [userId], references: [id])
  tips   Tip[]

  @@index([userId])
}

model Tip {
  id          Int        @id @default(autoincrement())
  userId      Int
  labReportId Int?
  nudgesId    Int?
  type        TipType
  message     String
  riskLevel   RiskLevel
  createdAt   DateTime   @default(now())
  labReport   LabReport? @relation(fields: [labReportId], references: [id])
  nudges      Nudge?     @relation(fields: [nudgesId], references: [id])
  user        User       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([labReportId])
  @@index([nudgesId])
}

model Conversation {
  id        Int      @id @default(autoincrement())
  title     String
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  chats     Chat[]
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

model Chat {
  id             Int          @id @default(autoincrement())
  conversationId Int
  senderId       Int
  type           MessageType
  content        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  sender         User         @relation("ChatSender", fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([createdAt])
}

enum Language {
  EN
  BN
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  OTHER
}

enum HealthGoal {
  LOSE_WEIGHT
  BUILD_MUSCLE
  MAINTAIN_HEALTH
  IMPROVE
}

enum TipType {
  LAB_REPORT
  NUDGES
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum Role {
  USER
  ADMIN
}

enum NudgeCategory {
  HYDRATION
  SLEEP
  MOVEMENT
  WEIGHT
  OTHER
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
  OTHER
}